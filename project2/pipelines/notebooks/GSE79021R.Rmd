```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 1: Setup environment and load packages
# =====================================================

setup_environment <- function() {
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

packages_cran <- c("ggplot2", "dplyr", "plotly", "tidyr", "stringr")
for(p in packages_cran) if(!requireNamespace(p, quietly = TRUE)) install.packages(p)

BiocManager::install(c("GEOquery", "limma"), ask = FALSE)

library(ggplot2); library(dplyr); library(plotly)
library(tidyr); library(stringr)
library(GEOquery); library(limma); library(gprofiler2)
}
setup_environment()
```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 2: Load GEO dataset
# =====================================================

load_geo_dataset <- function(filename) {
gse <- getGEO(filename = filename)
return(gse)
}
gse <- load_geo_dataset("../../data/external/GSE79021_family.soft.gz")
```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 3: Extract single sample data
# =====================================================

extract_sample_data <- function(sample) {
header <- Meta(sample)
table  <- Table(sample)

geo_accession <- header$geo_accession
characteristics <- paste(header$characteristics_ch1, collapse = "; ")

group <- str_match(characteristics, "group:\\s*([^;]+)")[,2]
bmi   <- str_match(characteristics, "bmi:\\s*([0-9.]+)")[,2]

df <- table %>%
mutate(
geo_accession = geo_accession,
group = trimws(group),
bmi   = as.numeric(bmi)
) %>%
select(geo_accession, group, bmi, ID_REF, VALUE)

return(df)
}
```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 4: Combine all samples into wide dataframe
# =====================================================

combine_samples <- function(gse) {
samples_list <- GSMList(gse)
dados_lista  <- lapply(samples_list, extract_sample_data)

dados_long <- bind_rows(dados_lista)

raw_data <- dados_long %>%
pivot_wider(
id_cols = c(geo_accession, group, bmi),
names_from = ID_REF,
values_from = VALUE
)

raw_data[ , -(1:3)] <- lapply(raw_data[ , -(1:3)], function(x) as.numeric(as.character(x)))
return(raw_data)
}
raw_data <- combine_samples(gse)
write.csv(dftumor_ob, "../../data/raw/raw_data.csv", row.names = FALSE)
head(raw_data)
```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 5: Subset dataset by tissue type and BMI
# =====================================================

subset_by_group_bmi <- function(df, tissue_type, bmi_cutoff, obese = TRUE) {
if(obese) {
subset_df <- df %>% filter(group == tissue_type, bmi >= bmi_cutoff)
} else {
subset_df <- df %>% filter(group == tissue_type, bmi < bmi_cutoff)
}
return(subset_df)
}

dftumor_ob <- subset_by_group_bmi(raw_data, "FFPE prostate tumor", 30, TRUE)
dftumor_np <- subset_by_group_bmi(raw_data, "FFPE prostate tumor", 30, FALSE)
dfnormal_ob <- subset_by_group_bmi(raw_data, "FFPE normal_prostate", 30, TRUE)
dfnormal_np <- subset_by_group_bmi(raw_data, "FFPE normal_prostate", 30, FALSE)

# Tumor samples / Obese
write.csv(dftumor_ob, "../../data/interim/dftumor_ob.csv", row.names = FALSE)
# Tumor samples / Non-obese
write.csv(dftumor_np, "../../data/interim/dftumor_np.csv", row.names = FALSE)
# Normal tissue / Obese
write.csv(dfnormal_ob, "../../data/interim/dfnormal_ob.csv", row.names = FALSE)
# Normal tissue / Non-obese
write.csv(dfnormal_np, "../../data/interim/dfnormal_np.csv", row.names = FALSE)

head(dftumor_np)
head(dftumor_ob)
head(dfnormal_np)
head(dfnormal_ob)
```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 6: Calculate DEGs and generate volcano plots
# =====================================================

calc_deg <- function(df1, df2, contrast_name, fc_thresh = 0.30103, p_thresh = -log10(0.05)) {
  # Extract expression data (skip metadata columns)
  expr1 <- df1[, 4:ncol(df1)]
  expr2 <- df2[, 4:ncol(df2)]
  
  # Find common genes across both datasets
  common_genes <- intersect(colnames(expr1), colnames(expr2))
  expr1 <- expr1[, common_genes]
  expr2 <- expr2[, common_genes]
  
  # Calculate mean expression per gene in each group
  mean1 <- colMeans(expr1, na.rm = TRUE)
  mean2 <- colMeans(expr2, na.rm = TRUE)
  
  # Compute log2 fold change
  log2FC <- log2(mean1 + 1e-8) - log2(mean2 + 1e-8)
  
  # Compute p-values using t-test for each gene
  pvals <- sapply(common_genes, function(g) {
    tryCatch(t.test(expr1[[g]], expr2[[g]])$p.value, error = function(e) 1)
  })
  
  # Create data frame with results
  deg <- data.frame(
    gene = common_genes,
    log2FC = log2FC,
    pvalue = pvals,
    negLog10P = -log10(pvals)
  )
  
  # Sort by |log2FC| and significance
  deg <- deg[order(-abs(deg$log2FC), deg$negLog10P, decreasing = TRUE), ]
  
  # Define significance categories
  deg$significance <- "NS"
  deg$significance[deg$log2FC > fc_thresh & deg$negLog10P > p_thresh] <- "Up"
  deg$significance[deg$log2FC < -fc_thresh & deg$negLog10P > p_thresh] <- "Down"
  
  # Export table
  write.csv(deg, paste0("../../data/processed/DEG_", contrast_name, ".csv"), row.names = FALSE)
  
  # Generate volcano plot
  p <- ggplot(deg, aes(x = log2FC, y = negLog10P, color = significance)) +
    geom_point(alpha = 0.7, size = 1.8) +
    scale_color_manual(values = c("Up"="red","Down"="blue","NS"="gray60")) +
    geom_vline(xintercept = c(-fc_thresh, fc_thresh), linetype="dashed") +
    geom_hline(yintercept = p_thresh, linetype="dashed") +
    theme_minimal() +
    ggtitle(paste("Volcano:", contrast_name))
  
  ggsave(paste0("../../assets/Volcano_", contrast_name, ".png"), p, width = 7, height = 6, dpi = 300)
  
  # Return results
  return(list(deg=deg, fc_thresh=fc_thresh, p_thresh=p_thresh))
}

# =====================================================
# Run comparisons
# =====================================================

deg_tumorNP_vs_normalNP  <- calc_deg(dftumor_np, dfnormal_np,  "TumorNP_vs_NormalNP")
deg_tumorOB_vs_normalOB  <- calc_deg(dftumor_ob, dfnormal_ob,  "TumorOB_vs_NormalOB")
deg_tumorOB_vs_tumorNP   <- calc_deg(dftumor_ob, dftumor_np,   "TumorOB_vs_TumorNP")
deg_normalOB_vs_normalNP <- calc_deg(dfnormal_ob, dfnormal_np, "NormalOB_vs_NormalNP")

head(deg_tumorNP_vs_normalNP$deg)

```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 7: Generate interactive volcano plots
# =====================================================

make_interactive_volcano <- function(deg_df, title, fc_thresh, p_thresh) {
p <- ggplot(deg_df, aes(
x = log2FC, y = negLog10P, color = significance,
text = paste("Gene:", gene, "<br>log2FC:", round(log2FC,3),
"<br>p-value:", signif(10^(-negLog10P),3))
)) +
geom_point(alpha=0.8) +
geom_vline(xintercept=c(-fc_thresh, fc_thresh), linetype="dashed", color="gray40") +
geom_hline(yintercept=p_thresh, linetype="dashed", color="gray40") +
scale_color_manual(values=c("Up"="red","Down"="blue","NS"="gray")) +
theme_minimal() +
labs(title=title, x="log2(Fold Change)", y="-log10(p-value)", color="Significance")

ggplotly(p, tooltip="text")
}

volcano1 <- make_interactive_volcano(deg_tumorNP_vs_normalNP$deg, "Tumor/Non-obese vs Normal/Non-obese", deg_tumorNP_vs_normalNP$fc_thresh, deg_tumorNP_vs_normalNP$p_thresh)
volcano2 <- make_interactive_volcano(deg_tumorOB_vs_normalOB$deg, "Tumor/Obese vs Normal/Obese", deg_tumorOB_vs_normalOB$fc_thresh, deg_tumorOB_vs_normalOB$p_thresh)
volcano3 <- make_interactive_volcano(deg_tumorOB_vs_tumorNP$deg, "Tumor/Obese vs Tumor/Non-obese", deg_tumorOB_vs_tumorNP$fc_thresh, deg_tumorOB_vs_tumorNP$p_thresh)
volcano4 <- make_interactive_volcano(deg_normalOB_vs_normalNP$deg, "Normal/Obese vs Normal/Non-obese", deg_normalOB_vs_normalNP$fc_thresh, deg_normalOB_vs_normalNP$p_thresh)

volcano1
volcano2
volcano3
volcano4
```

```{r}
# =====================================================
# Export top lists for STRING (symbols) and nodes for Cytoscape
# =====================================================
export_deg_sets <- function(deg_obj, tag, top_n = 300){
  # Detect if it's a list returned by calc_deg()
  if (is.list(deg_obj) && "deg" %in% names(deg_obj)) {
    deg_df <- deg_obj$deg
  } else {
    deg_df <- deg_obj
  }

  cutP <- -log10(p_thresh_color)
  up   <- deg_df |> dplyr::filter(log2FC >  fc_thresh_color & negLog10P > cutP) |> dplyr::arrange(dplyr::desc(log2FC))
  down <- deg_df |> dplyr::filter(log2FC < -fc_thresh_color & negLog10P > cutP) |> dplyr::arrange(log2FC)

  # STRING lists
  writeLines(head(up$gene,   top_n), paste0("STRING_genes_UP_",   tag, ".txt"))
  writeLines(head(down$gene, top_n), paste0("STRING_genes_DOWN_", tag, ".txt"))

  # Nodes for Cytoscape
  nodes <- dplyr::mutate(deg_df,
                         DE_class = dplyr::case_when(
                           log2FC >  fc_thresh_color & negLog10P > cutP ~ "Up",
                           log2FC < -fc_thresh_color & negLog10P > cutP ~ "Down",
                           TRUE ~ "NS"
                         )) |>
           dplyr::select(name = gene, logFC = log2FC, DE_class) |>
           dplyr::distinct(name, .keep_all = TRUE)
  readr::write_csv(nodes, paste0("NODES_for_Cytoscape_", tag, ".csv"))

  cat("\n[", tag, "] Up:", nrow(up), " Down:", nrow(down),
      " (cutoffs: |log2FC|>", fc_thresh_color, ", p<", p_thresh_color,")\n")
}


export_deg_sets(deg_tumorNP_vs_normalNP,  "TumorNP_vs_NormalNP")
export_deg_sets(deg_tumorOB_vs_normalOB,  "TumorOB_vs_NormalOB")
export_deg_sets(deg_tumorOB_vs_tumorNP,   "TumorOB_vs_TumorNP")
export_deg_sets(deg_normalOB_vs_normalNP, "NormalOB_vs_NormalNP")
```

```{r, message=FALSE, warning=FALSE}
# =====================================================
# Chunk 8: Functional enrichment analysis
# =====================================================

perform_enrichment <- function(genes, top_n=15) {
gostres <- gost(query=genes, organism="hsapiens", significant=TRUE, correction_method="fdr")

df <- gostres$result %>%
mutate(genes_text = if("intersection" %in% colnames(.)) intersection else paste("Number of genes:", intersection_size)) %>%
group_by(term_name) %>% slice_min(p_value, n=1) %>% ungroup() %>%
arrange(p_value) %>% slice(1:top_n) %>%
mutate(term_name=factor(term_name, levels=rev(term_name)), logp=-log10(p_value))

p <- ggplot(df, aes(x=term_name, y=logp, fill=source, text=paste("Genes:", genes_text, "<br>p-value:", signif(p_value,3)))) +
geom_bar(stat="identity") + coord_flip() + theme_minimal() +
labs(x="", y="-log10(p-value)", title=paste("Top", top_n, "enriched terms"))

ggsave("../../assets/enrichment_plot.png", p, width = 8, height = 6, dpi = 300)

ggplotly(p, tooltip="text")
}

genes <- c("MIR24.2","MIR186","MIR100","C21orf94","LOC285456",
"SNORD115.38","SNORD113.4","MIR19B2","SUMO1","TPTE2P3",
"ZNF443","SNORD115.8","IFIT1","MIR222","SNORD116.18",
"SNORD37","PLAC4","DKFZp686O24166","IFI44L")

enrichment_plot <- perform_enrichment(genes, top_n=15)
enrichment_plot
```
